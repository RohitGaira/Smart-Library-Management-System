# Smart Library Management System - Complete Workflow

**Version:** 2.0  
**Last Updated:** 2025-10-09  
**Status:** âœ… Production Ready

---

## ðŸ“‹ **Table of Contents**

1. [Overview](#overview)
2. [Complete Workflow Diagram](#complete-workflow-diagram)
3. [Step-by-Step Flow](#step-by-step-flow)
4. [Database State Transitions](#database-state-transitions)
5. [Error Handling](#error-handling)
6. [Audit Trail](#audit-trail)

---

## ðŸŽ¯ **Overview**

The SLMS workflow is designed around a **librarian-centric** approach where:
- Books are added with automatic metadata extraction
- Librarians review and confirm/edit metadata
- Approved books are inserted into the main catalogue
- Complete audit trail tracks every action

**Key Principles:**
- âœ… Database-first (all operations persisted)
- âœ… Idempotent (safe retries)
- âœ… Transactional (atomic operations)
- âœ… Auditable (complete traceability)

---

## ðŸ”„ **Complete Workflow Diagram**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STEP 1: ADD BOOK TO CATALOGUE                     â”‚
â”‚                   POST /catalogue/add                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  1. Validate Input                     â”‚
        â”‚  â”œâ”€ ISBN format (10 or 13 digits)      â”‚
        â”‚  â”œâ”€ Title (required)                   â”‚
        â”‚  â””â”€ total_copies >= 1                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. Create Pending Entry (DB)          â”‚
        â”‚  INSERT INTO pending_catalogue         â”‚
        â”‚  â”œâ”€ isbn, title, authors               â”‚
        â”‚  â”œâ”€ total_copies                       â”‚
        â”‚  â”œâ”€ status = 'pending'                 â”‚
        â”‚  â”œâ”€ raw_metadata = NULL                â”‚
        â”‚  â””â”€ output_json = NULL                 â”‚
        â”‚  COMMIT & Get pending_id               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  3. Create Audit Log                   â”‚
        â”‚  INSERT INTO catalogue_audit           â”‚
        â”‚  â”œâ”€ id = pending_id               â”‚
        â”‚  â”œâ”€ action = 'input_received'          â”‚
        â”‚  â”œâ”€ source = 'frontend'                â”‚
        â”‚  â””â”€ timestamp = NOW()                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  4. Fetch Metadata (External APIs)     â”‚
        â”‚  â”œâ”€ Try Open Library (primary)         â”‚
        â”‚  â”œâ”€ Try Google Books (fallback)        â”‚
        â”‚  â””â”€ Merge results                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â”€ Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                      â”‚
                 â”‚                      â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  5. Update Pending Entry   â”‚
                 â”‚         â”‚  UPDATE pending_catalogue  â”‚
                 â”‚         â”‚  SET raw_metadata = {...}  â”‚
                 â”‚         â”‚      status = 'awaiting_   â”‚
                 â”‚         â”‚               confirmation' â”‚
                 â”‚         â”‚  WHERE id = pending_id     â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â”‚                  â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  6. Create Audit Log       â”‚
                 â”‚         â”‚  action = 'metadata_       â”‚
                 â”‚         â”‚           extracted'       â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â”‚                  â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  7. Return Success         â”‚
                 â”‚         â”‚  {                         â”‚
                 â”‚         â”‚    "pending_id": xyz,      â”‚
                 â”‚         â”‚    "status": "awaiting_    â”‚
                 â”‚         â”‚              confirmation",â”‚
                 â”‚         â”‚    "metadata_preview": {   â”‚
                 â”‚         â”‚      "title": "...",       â”‚
                 â”‚         â”‚      "authors": [...],     â”‚
                 â”‚         â”‚      "publisher": "..."    â”‚
                 â”‚         â”‚    }                       â”‚
                 â”‚         â”‚  }                         â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â””â”€â”€â”€ Failed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚
                                        â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  5. Update Pending Entry   â”‚
                         â”‚  UPDATE pending_catalogue  â”‚
                         â”‚  SET status = 'failed'     â”‚
                         â”‚  WHERE id = pending_id     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  6. Create Audit Log       â”‚
                         â”‚  action = 'metadata_       â”‚
                         â”‚           extraction_      â”‚
                         â”‚           failed'          â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  7. Return Partial Success â”‚
                         â”‚  {                         â”‚
                         â”‚    "pending_id": xyz,      â”‚
                         â”‚    "status": "failed",     â”‚
                         â”‚    "message": "Metadata    â”‚
                         â”‚               extraction   â”‚
                         â”‚               failed."     â”‚
                         â”‚  }                         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              STEP 2: LIBRARIAN VIEWS PENDING BOOKS                   â”‚
â”‚              GET /catalogue/pending                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  1. Query Database                     â”‚
        â”‚  SELECT * FROM pending_catalogue       â”‚
        â”‚  WHERE status IN ('awaiting_           â”‚
        â”‚                    confirmation',      â”‚
        â”‚           'Metadata_extraction_failed')â”‚
        â”‚  ORDER BY created_at ASC               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. Return List                        â”‚
        â”‚  [                                     â”‚
        â”‚    {                                   â”‚
        â”‚      "id": xyz,                        â”‚
        â”‚      "isbn": "9780132350884",          â”‚
        â”‚      "title": "Clean Code",            â”‚
        â”‚      "authors": ["Robert C. Martin"],  â”‚
        â”‚      "raw_metadata": {                 â”‚
        â”‚        "publisher": "Prentice Hall",   â”‚
        â”‚        "publication_year": "2008",     â”‚
        â”‚        ...                             â”‚
        â”‚      },                                â”‚
        â”‚      "status": "awaiting_confirmation",â”‚
        â”‚      "created_at": "2025-10-09T14:00"  â”‚
        â”‚    }                                   â”‚
        â”‚  ]                                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         STEP 3: LIBRARIAN CONFIRMS/REJECTS METADATA                  â”‚
â”‚         POST /catalogue/confirm/{pending_id}                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  1. Fetch Pending Entry (with lock)    â”‚
        â”‚  SELECT * FROM pending_catalogue       â”‚
        â”‚  WHERE id = pending_id(xyz)                 â”‚
        â”‚  FOR UPDATE                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. Validate Status                    â”‚
        â”‚  Must be: 'awaiting_confirmation' or   â”‚
        â”‚           'failed'                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â”€ APPROVED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                      â”‚
                 â”‚                      â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  3. Apply Librarian Edits  â”‚
                 â”‚         â”‚  merged = raw_metadata +   â”‚
                 â”‚         â”‚           edits            â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â”‚                  â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  4. Create output_json     â”‚
                 â”‚         â”‚  (finalized metadata)      â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â”‚                  â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  5. Update Database        â”‚
                 â”‚         â”‚  UPDATE pending_catalogue  â”‚
                 â”‚         â”‚  SET status = 'approved'   â”‚
                 â”‚         â”‚      output_json = {...}   â”‚
                 â”‚         â”‚  WHERE id = pending_id     â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â”‚                  â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  6. Create Audit Log       â”‚
                 â”‚         â”‚  action = 'approved'       â”‚
                 â”‚         â”‚  source = 'librarian'      â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  â”‚
                 â”‚                  â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  7. Return Success         â”‚
                 â”‚         â”‚  {                         â”‚
                 â”‚         â”‚    "status": "approved",   â”‚
                 â”‚         â”‚    "output_json": {...}    â”‚
                 â”‚         â”‚  }                         â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â””â”€â”€â”€ REJECTED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚
                                        â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  3. Update Database        â”‚
                         â”‚  UPDATE pending_catalogue  â”‚
                         â”‚  SET status = 'rejected'   â”‚
                         â”‚  WHERE id = pending_id     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  4. Create Audit Log       â”‚
                         â”‚  action = 'rejected'       â”‚
                         â”‚  source = 'librarian'      â”‚
                         â”‚  details = reason          â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  5. Return Response        â”‚
                         â”‚  {                         â”‚
                         â”‚    "status": "rejected"    â”‚
                         â”‚  }                         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           STEP 4: INSERT INTO MAIN CATALOGUE                         â”‚
â”‚           POST /catalogue/insert/{pending_id}                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  1. Fetch & Lock Pending Entry         â”‚
        â”‚  SELECT * FROM pending_catalogue       â”‚
        â”‚  WHERE id = pending_id                 â”‚
        â”‚  FOR UPDATE                            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  2. Validate Status                    â”‚
        â”‚  Must be: 'approved'                   â”‚
        â”‚  (Idempotent: if 'completed', return)  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  3. Extract & Normalize Metadata       â”‚
        â”‚  Source: output_json                   â”‚
        â”‚  â”œâ”€ Normalize ISBNs                    â”‚
        â”‚  â”œâ”€ Extract title (required)           â”‚
        â”‚  â””â”€ Extract authors, publisher         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  4. Upsert Publisher                   â”‚
        â”‚  INSERT INTO publishers                â”‚
        â”‚  ON CONFLICT (name) DO NOTHING         â”‚
        â”‚  RETURNING publisher_id                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  5. Upsert Authors                     â”‚
        â”‚  FOR EACH author:                      â”‚
        â”‚    INSERT INTO authors                 â”‚
        â”‚    ON CONFLICT (full_name) DO NOTHING  â”‚
        â”‚  Collect author_ids                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  6. Check if Book Exists               â”‚
        â”‚  SELECT * FROM books                   â”‚
        â”‚  WHERE isbn_13 = '...'                 â”‚
        â”‚     OR isbn_10 = '...'                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”œâ”€â”€â”€ EXISTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                       â”‚
                 â”‚                       â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  7A. Add Copies             â”‚
                 â”‚         â”‚  UPDATE books               â”‚
                 â”‚         â”‚  SET total_copies += N      â”‚
                 â”‚         â”‚      available_copies += N  â”‚
                 â”‚         â”‚  WHERE book_id = X          â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚
                 â”‚                   â–¼
                 â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚         â”‚  8A. Create Audit Log       â”‚
                 â”‚         â”‚  action = 'copies_added'    â”‚
                 â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                   â”‚
                 â”‚                   â””â”€â”€â”€â”€â”€â”€â”
                 â”‚                          â”‚
                 â””â”€â”€â”€ NEW BOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                                        â”‚   â”‚
                                        â–¼   â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  7B. Insert New Book         â”‚
                         â”‚  INSERT INTO books           â”‚
                         â”‚  (isbn, isbn_10, isbn_13,    â”‚
                         â”‚   title, publisher_id, ...)  â”‚
                         â”‚  RETURNING book_id           â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  8B. Link Authors            â”‚
                         â”‚  FOR EACH author_id:         â”‚
                         â”‚    INSERT INTO book_authors  â”‚
                         â”‚    (book_id, author_id)      â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  9B. Create Audit Log        â”‚
                         â”‚  action = 'inserted'         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”
                                           â”‚
                                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  9. Mark Pending as Completed                  â”‚
        â”‚  UPDATE pending_catalogue                      â”‚
        â”‚  SET status = 'completed'                      â”‚
        â”‚  WHERE id = pending_id                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  10. Create Final Audit Log            â”‚
        â”‚  action = 'pending_completed'          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  11. COMMIT Transaction                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  12. Return Success                    â”‚
        â”‚  {                                     â”‚
        â”‚    "message": "Book inserted",         â”‚
        â”‚    "pending_id": xyz,                  â”‚
        â”‚    "book_id": abc,                     â”‚
        â”‚    "status": "completed"               â”‚
        â”‚  }                                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š **Database State Transitions**

### **pending_catalogue.status Lifecycle**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pending â”‚  â† Initial state after POST /catalogue/add
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ Metadata extraction succeeds â”€â”€â”€â”
     â”‚                                    â”‚
     â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ awaiting_confirmationâ”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ Librarian approves â”€â”€â”€â”
     â”‚                           â”‚
     â–¼                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚ approved â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ Insertion succeeds â”€â”€â”€â”
     â”‚                           â”‚
     â–¼                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚ completed â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Alternative paths:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pending â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ Metadata extraction fails â”€â”€â”€â”
     â”‚                                  â”‚
     â–¼                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚ failed â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
     â”‚
     â””â”€â”€â”€ Librarian can manually enter data
          and approve â†’ 'approved'

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ awaiting_confirmationâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€â”€â”€ Librarian rejects â”€â”€â”€â”
     â”‚                          â”‚
     â–¼                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚ rejected â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Valid Status Transitions**

| From | To | Trigger | Action |
|------|-----|---------|--------|
| `pending` | `awaiting_confirmation` | Metadata extracted | Auto |
| `pending` | `failed` | Metadata extraction failed | Auto |
| `awaiting_confirmation` | `approved` | Librarian approves | Manual |
| `awaiting_confirmation` | `rejected` | Librarian rejects | Manual |
| `failed` | `approved` | Librarian manually enters data | Manual |
| `approved` | `completed` | Book inserted successfully | Auto |

---

## âš ï¸ **Error Handling**

### **Metadata Extraction Failures**

**Scenario:** External APIs (Open Library, Google Books) fail or return no results

**Behavior:**
1. Pending entry is still created with `status='failed'`
2. Audit log records `action='metadata_extraction_failed'`
3. Response indicates failure but provides `pending_id`
4. Librarian can manually enter metadata and approve

**Example Response:**
```json
{
  "message": "Book added but metadata extraction failed. Please enter manually.",
  "pending_id": 123,
  "status": "failed",
  "metadata_preview": null
}
```

### **Validation Errors**

**Scenario:** Invalid input (bad ISBN format, missing required fields)

**Behavior:**
1. Request rejected with HTTP 400
2. No database entry created
3. Clear error message returned

**Example Response:**
```json
{
  "detail": "ISBN must be exactly 10 or 13 digits"
}
```

### **Database Errors**

**Scenario:** Database connection failure, constraint violation

**Behavior:**
1. Transaction rolled back
2. HTTP 500 returned
3. Error logged for debugging
4. No partial state left in database

### **Insertion Failures**

**Scenario:** Book insertion fails (missing required data, constraint violation)

**Behavior:**
1. Transaction rolled back
2. Pending entry remains in `approved` state
3. Audit log records `action='insert_failed'` with error details
4. Can be retried (idempotent)

---

## ðŸ“ **Audit Trail**

Every action in the workflow is logged to `catalogue_audit` table for complete traceability.

### **Audit Actions**

| Action | Source | When | Details |
|--------|--------|------|---------|
| `input_received` | `frontend` | Book added | Initial request data |
| `metadata_extracted` | `metadata_pipeline` | APIs succeed | Source API used |
| `metadata_extraction_failed` | `metadata_pipeline` | APIs fail | Error message |
| `approved` | `librarian` | Librarian approves | Edits applied |
| `rejected` | `librarian` | Librarian rejects | Rejection reason |
| `inserted` | `insertion_service` | New book created | book_id, ISBN, title |
| `copies_added` | `insertion_service` | Existing book updated | book_id, copies added |
| `pending_completed` | `insertion_service` | Process complete | Final book_id |
| `insert_failed` | `insertion_service` | Insertion error | Error details |

### **Querying Audit Logs**

```sql
-- Get complete history for a pending entry
SELECT action, source, details, timestamp
FROM lms_core.catalogue_audit
WHERE book_id = 123
ORDER BY timestamp ASC;

-- Count books processed today
SELECT COUNT(DISTINCT book_id)
FROM lms_core.catalogue_audit
WHERE action = 'pending_completed'
  AND timestamp >= CURRENT_DATE;

-- Find failed insertions
SELECT book_id, details, timestamp
FROM lms_core.catalogue_audit
WHERE action = 'insert_failed'
ORDER BY timestamp DESC
LIMIT 10;
```

---

## ðŸŽ¯ **Summary**

**Workflow Characteristics:**
- âœ… **4-Step Process**: Add â†’ Review â†’ Confirm â†’ Insert
- âœ… **Automatic Metadata**: Fetched from Open Library + Google Books
- âœ… **Human Oversight**: Librarian reviews and edits before final insertion
- âœ… **Fault Tolerant**: Handles API failures gracefully
- âœ… **Fully Audited**: Every action logged with timestamp
- âœ… **Idempotent**: Safe to retry any step
- âœ… **Transactional**: No partial state on errors

**Next Steps:**
- See [API_ENDPOINTS.md](API_ENDPOINTS.md) for detailed API documentation, frontend integration guidance, and all workflow endpoint details

---

**For Questions or Issues:**
- Check audit logs: `GET /catalogue/audit/{pending_id}`
- Review application logs
- Run tests: `pytest tests/ -v`
